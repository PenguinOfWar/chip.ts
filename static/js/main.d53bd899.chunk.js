(this["webpackJsonpchip.ts"]=this["webpackJsonpchip.ts"]||[]).push([[0],{61:function(e,t,s){},62:function(e,t,s){},64:function(e,t,s){},65:function(e,t,s){},66:function(e,t,s){"use strict";s.r(t);var i=s(1),r=s.n(i),n=s(29),c=s.n(n),a=s(17),o=s(30),h=s(19),l=s(13),d=s(33),u=s.n(d),b=s(12),j=s(34),p=s.n(j);var g=function(){var e=this;return new Promise((function(t){var s=new FileReader;s.onload=function(){t(s.result)},s.readAsArrayBuffer(e)}))},f=s(6),k=s(7),x=s(20),m=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128],v=window.AudioContext||window.webkitAudioContext,O=function(){function e(t,s){Object(f.a)(this,e),this.memory=new Uint8Array(new ArrayBuffer(4096)),this.registers=new Uint8Array(16),this.stack=new Uint16Array(16),this.stackPointer=0,this.counter=512,this.gfx=void 0,this.pointer=0,this.screen=new Uint8Array,this.delayTimer=0,this.soundTimer=0,this.keys={},this.key=0,this.speaker=new v,this.wave="sawtooth",this.running=!1,this.gfx=s,this.screen=new Uint8Array(this.gfx.resolution.x*this.gfx.resolution.y),this.load(t)}return Object(k.a)(e,[{key:"load",value:function(e){var t=this;this.loadFont(),e.map((function(e,s){var i=s+512;return t.memory[i]=e,e})),this.start()}},{key:"loadFont",value:function(){var e=this;return m.map((function(t,s){return e.memory[s]=t}))}},{key:"start",value:function(){this.running=!0}},{key:"stop",value:function(){this.running=!1}},{key:"next",value:function(e,t){this.running&&(this.tick(),e(Object(x.a)(Object(x.a)({},t),{},{cpu:{counter:this.counter,delayTimer:this.delayTimer,key:this.key,memory:this.memory,pointer:this.pointer,registers:this.registers,running:this.running,screen:this.screen,soundTimer:this.soundTimer,stack:this.stack,stackPointer:this.stackPointer}})))}},{key:"tick",value:function(){this.delayTimer>0&&--this.delayTimer,this.soundTimer>0&&(this.running&&1===this.soundTimer&&this.beep(),--this.soundTimer);var e=this.memory[this.counter]<<8|this.memory[this.counter+1],t=(3840&e)>>8,s=(240&e)>>4,i=255&e,r=4095&e,n=!1;switch(61440&e){case 0:switch(e){case 224:this.disp_clear();break;case 238:0===this.stack[this.stackPointer]&&console.warn("Invalid return from subroutine."),this.counter=this.stack[this.stackPointer],this.stack[this.stackPointer]=0,this.stackPointer>0&&--this.stackPointer}break;case 4096:this.counter=r,n=!0;break;case 8192:0!==this.stack[this.stackPointer]&&++this.stackPointer,this.stack[this.stackPointer]=this.counter,this.counter=r,n=!0;break;case 12288:this.registers[t]===i&&(this.counter+=2);break;case 16384:this.registers[t]!==i&&(this.counter+=2);break;case 20480:this.registers[t]===this.registers[s]&&(this.counter+=2);break;case 24576:this.registers[t]=255&e;break;case 28672:this.registers[t]+=i;break;case 32768:switch(15&e){case 0:this.registers[t]=this.registers[s];break;case 1:this.registers[t]=this.registers[t]|this.registers[s];break;case 2:this.registers[t]=this.registers[t]&this.registers[s];break;case 3:this.registers[t]=this.registers[t]^this.registers[s];break;case 4:this.registers[t]+this.registers[s]>255?this.registers[15]=1:this.registers[15]=0,this.registers[t]+=this.registers[s];break;case 5:this.registers[t]<this.registers[s]?this.registers[15]=0:this.registers[15]=1,this.registers[t]-=this.registers[s];break;case 6:this.registers[t]%2===0?this.registers[15]=0:this.registers[15]=1,this.registers[t]=this.registers[t]>>1;break;case 7:this.registers[s]<this.registers[t]?this.registers[15]=0:this.registers[15]=1,this.registers[t]=this.registers[s]-this.registers[t];break;case 14:this.registers[t]<128?this.registers[15]=0:this.registers[15]=1,this.registers[t]=this.registers[t]<<1;break;default:throw new Error("Unknown opcode in 8000 block: ".concat(e.toString(16)))}break;case 36864:this.registers[t]!==this.registers[s]&&(this.counter+=2);break;case 40960:this.pointer=r;break;case 45056:this.counter=(4095&e)+this.registers[0],n=!0;break;case 49152:this.registers[t]=Math.floor(255*Math.random())%255&i;break;case 53248:var c,a=15&e,o={x:this.registers[t],y:this.registers[s]};this.registers[15]=0;for(var h=0;h<a;h++){c=this.memory[this.pointer+h];for(var l=0;l<this.gfx.resolution.scale;l++)o.x+l===this.gfx.resolution.x&&(o.x=-l),o.y+h===this.gfx.resolution.y&&(o.y=-h),(128&c)>0&&this.setPixel(this.registers[t]+l,this.registers[s]+h)&&(this.registers[15]=1),c<<=1;o.x=this.registers[t],o.y=this.registers[s]}break;case 57344:switch(i){case 158:this.key===this.registers[t]&&(this.counter+=2);break;case 161:this.key!==this.registers[t]&&(this.counter+=2);break;default:throw new Error("Unknown opcode in e000 block: ".concat(e.toString(16)))}break;case 61440:switch(i){case 7:this.registers[t]=this.delayTimer;break;case 10:if(0===this.key)return void this.stop();this.registers[t]=this.key,this.start();break;case 21:this.delayTimer=this.registers[t];break;case 24:this.soundTimer=this.registers[t];break;case 30:this.pointer+=this.registers[t];break;case 41:this.pointer=5*this.registers[t];break;case 51:var d=[this.registers[t]/100,this.registers[t]/10%10,this.registers[t]%10];this.memory[this.pointer]=d[0],this.memory[this.pointer+1]=d[1],this.memory[this.pointer+2]=d[2];break;case 85:for(var u=0;u<=t;u++)this.memory[this.pointer+u]=this.registers[u];break;case 101:for(var b=0;b<=t;b++)this.registers[b]=this.memory[this.pointer+b];this.pointer=this.pointer+t+1}break;default:throw new Error("Unknown opcode: ".concat(e.toString(16)))}n||(this.counter+=2)}},{key:"display",get:function(){return this.screen}},{key:"setPixel",value:function(e,t){var s=this.gfx.resolution.x,i=this.gfx.resolution.y;e>s?e-=s:e<0&&(e+=s),t>i?t-=i:t<0&&(t+=i);var r=e+t*s;return this.display[r]^=1,!this.screen[r]}},{key:"input",value:function(e){this.key=e}},{key:"beep",value:function(){if(this.speaker){var e=this.speaker.createOscillator();return e.connect(this.speaker.destination),e.type=this.wave,e.start(),void setTimeout((function(){e.stop()}),100)}}},{key:"halt",value:function(){this.speaker&&this.speaker.close()}},{key:"disp_clear",value:function(){var e=new Uint8Array(this.gfx.resolution.x*this.gfx.resolution.y);this.screen=e}}]),e}(),y=function(){function e(t){Object(f.a)(this,e),this.colors={background:"#000",foreground:"#00ff00"},this.canvas=null,this.context=null,this.grid=!1,this.gridNode=void 0,this.resolution={x:64,y:32,scale:8},this.canvas=t.current,this.boot()}return Object(k.a)(e,[{key:"toggleGrid",value:function(){this.grid=!this.grid}},{key:"boot",value:function(){this.context=this.canvas.getContext("2d"),this.canvas.width=this.resolution.x*this.resolution.scale,this.canvas.height=this.resolution.y*this.resolution.scale}},{key:"drawGrid",value:function(){if(this.context&&this.grid){var e=this.context,t=window.URL||window.webkitURL||window,s=new Image,i=new Blob(['<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"> \n        <defs> \n            <pattern id="smallGrid" width="8" height="8" patternUnits="userSpaceOnUse"> \n                <path d="M 8 0 L 0 0 0 8" fill="none" stroke="gray" stroke-width="0.5" /> \n            </pattern> \n            <pattern id="grid" width="80" height="80" patternUnits="userSpaceOnUse"> \n                <rect width="80" height="80" fill="url(#smallGrid)" /> \n                <path d="M 80 0 L 0 0 0 80" fill="none" stroke="gray" stroke-width="1" /> \n            </pattern> \n        </defs> \n        <rect width="100%" height="100%" fill="url(#smallGrid)" /> \n    </svg>'],{type:"image/svg+xml;charset=utf-8"}),r=t.createObjectURL(i);s.onload=function(){e.drawImage(s,0,0),t.revokeObjectURL(r)},s.src=r,this.gridNode=s}else{var n,c;null===(n=this.gridNode)||void 0===n||null===(c=n.parentNode)||void 0===c||c.removeChild(this.gridNode)}}},{key:"paint",value:function(e){var t=this;if(this.context){var s=this.context,i=this.resolution;e.map((function(e,r){var n=r%i.x*i.scale,c=Math.floor(r/i.x)*i.scale;return s.fillStyle=[t.colors.background,t.colors.foreground][e],s.strokeStyle=[t.colors.background,t.colors.foreground][e],s.fillRect(n,c,t.resolution.scale,t.resolution.scale),e}))}}}]),e}(),w=function(){function e(t){Object(f.a)(this,e),this.cpu=void 0,this.cpu=t,this.listen()}return Object(k.a)(e,[{key:"press",value:function(e){var t;switch(e){case" ":case"Escape":this.cpu.running?this.cpu.stop():this.cpu.start();break;case"1":t=1;break;case"2":t=2;break;case"3":t=3;break;case"4":t=12;break;case"q":t=4;break;case"w":t=5;break;case"e":t=6;break;case"r":t=13;break;case"a":t=7;break;case"s":t=8;break;case"d":t=9;break;case"f":t=14;break;case"z":t=10;break;case"x":t=0;break;case"c":t=11;break;case"v":t=15}t&&this.cpu.input(t)}},{key:"release",value:function(){this.cpu.input(0)}},{key:"listen",value:function(){var e=this;this.cpu&&(document.addEventListener("keydown",(function(t){var s=t.key;e.press(s)})),document.addEventListener("keyup",(function(){e.release()})))}}]),e}(),N=["Brix","Invaders","Tetris","Pong","UFO","IBM","Missile","Tank","Maze"],C=[["1","2","3","4"],["q","w","e","r"],["a","s","d","f"],["z","x","c","v"]],P={brix:"Left: Q | Right: E",tetris:"Left: W | Right: E | Rotate: Q",pong:"P1 Up: 1 | P1 Down: Q | P2 Up: 4 | P2 Down: R",ufo:"Up/Left: Q | Up: W | Up/Right: E",ibm:"None",invaders:"Start: W | Shoot: W| Left: Q | Right: R",missile:"Shoot: S",tank:"Shoot: W | Left: Q | Up: S | Right: E | Down: 2",maze:"None"},T=function(){function e(t,s,i){Object(f.a)(this,e),this.speed=60,this.frame=0,this.cpu=void 0,this.gfx=void 0,this.keyboard=void 0,this.specialCases={},this.dispatch.bind(this),this.specialCases[t.toLowerCase()]&&(this.speed=this.specialCases[t.toLowerCase()].speed||this.speed);var r=new y(i),n=new O(s,r);this.cpu=n,this.gfx=r,this.keyboard=new w(n),this.start(n,r)}return Object(k.a)(e,[{key:"dispatch",value:function(e){if(CustomEvent instanceof Function){var t={cpu:e.cpu,frame:e.frame,speed:e.speed},s=new CustomEvent("chipDebug",{detail:t});document.dispatchEvent(s)}}},{key:"start",value:function(e,t){var s=this,i=!1,r={frame:this.frame,speed:this.speed};setInterval((function(){i||(i=!0,e.next(s.dispatch,r),i=!1)}),1e3/this.speed);this.frame=requestAnimationFrame((function i(){s.frame=requestAnimationFrame(i);var r=e.display;t.paint(r)}))}},{key:"stop",value:function(){cancelAnimationFrame(this.frame),this.cpu.halt()}}]),e}(),U=(s(61),s(62),s(0));function S(e){var t=e.data,s=Array.from(t);return s&&s.length>0?Object(U.jsxs)("table",{className:"stack-view w-100 text-center",children:[Object(U.jsx)("thead",{children:Object(U.jsx)("tr",{children:s.map((function(e,t){return Object(U.jsx)("td",{children:t},t)}))})}),Object(U.jsx)("tbody",{children:Object(U.jsx)("tr",{children:s.map((function(e,t){return Object(U.jsx)("td",{children:Object(U.jsx)("div",{className:"ratio ratio-1x1 bg-primary text-bg-primary text-center rounded",children:Object(U.jsx)("div",{children:e})})},t)}))})})]}):Object(U.jsx)("strong",{children:"'No data'"})}s(64);function L(e){var t=e.data,s=e.format;return Object(U.jsx)("div",{className:"debug-array-table",children:"stack"===s?Object(U.jsx)(S,{data:t}):Object(U.jsx)("table",{className:"table w-100",children:Object(U.jsx)("tbody",{children:Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"1"}),Object(U.jsx)("td",{children:"Mark"}),Object(U.jsx)("td",{children:"Otto"}),Object(U.jsx)("td",{children:"@mdo"})]})})})})}var E=function(){var e,t,s,r,n,c,d,j,f,k=Object(i.useRef)(null),x=Object(i.useState)(N[0].toLowerCase()),m=Object(h.a)(x,2),v=m[0],O=m[1],y=Object(i.useState)({}),w=Object(h.a)(y,2),S=w[0],E=w[1],A=Object(i.useCallback)(Object(o.a)(Object(a.a)().mark((function e(){var t,s,i,r,n;return Object(a.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return window.chip&&window.chip.stop(),e.next=3,u()({url:"".concat("/chip.ts","/roms/").concat(v),method:"GET",responseType:"blob"});case 3:return t=e.sent,File.prototype.arrayBuffer=File.prototype.arrayBuffer||g,Blob.prototype.arrayBuffer=Blob.prototype.arrayBuffer||g,s=new Blob([t.data]),e.next=9,s.arrayBuffer();case 9:i=e.sent,r=new Uint8Array(i),n=new T(v,r,k),window.chip=n;case 13:case"end":return e.stop()}}),e)}))),[v]);Object(i.useEffect)((function(){Object(b.a)()&&k&&null!==k&&void 0!==k&&k.current&&A()}),[v,k,A]);var R=function(e){Object(b.a)()&&(window.chip.keyboard.press(e),setTimeout((function(){window.chip.keyboard.release()}),200))},B=Object(i.useCallback)((function(e){E(e.detail),console.log(e.detail.cpu)}),[]);return Object(i.useEffect)((function(){return document.addEventListener("chipDebug",B),function(){document.removeEventListener("chipDebug",B)}}),[B]),Object(U.jsxs)("div",{className:"container app",children:[Object(U.jsx)("div",{className:"row",children:Object(U.jsxs)("div",{className:"col-12 text-center mb-3",children:[Object(U.jsx)("h1",{className:"mb-0",children:"CHIP.ts"}),Object(U.jsx)("h2",{children:Object(U.jsx)("small",{className:"text-muted",children:"A CHIP-8 emulator in TypeScript"})}),Object(U.jsx)("canvas",{"data-testid":"canvas",ref:k})]})}),Object(U.jsxs)("div",{className:"row",children:[Object(U.jsx)("div",{className:"col-12 text-center mb-2",children:Object(U.jsx)("button",{className:"btn btn-secondary",onClick:function(){R("Escape")},children:"Pause (Escape / Spacebar)"})}),Object(U.jsx)("div",{className:"col-6 text-center mb-2 d-none",children:Object(U.jsx)("button",{className:"btn btn-secondary",onClick:function(){Object(b.a)()&&window.chip.gfx.toggleGrid()},children:"Toggle Grid"})}),Object(U.jsx)("div",{className:"col-12",children:C.map((function(e,t){return Object(U.jsx)("div",{className:"row",children:e.map((function(e){return Object(U.jsx)("div",{className:"col-3 text-center mb-2",children:Object(U.jsx)("button",{className:"btn btn-secondary w-100",onClick:function(){R(e)},children:e.toUpperCase()})},e)}))},t)}))})]}),P[v]&&Object(U.jsx)("div",{className:"row",children:Object(U.jsx)("div",{className:"col-12",children:Object(U.jsxs)("div",{className:"alert alert-secondary",role:"alert",children:[Object(U.jsxs)("h2",{children:[v," keys:"]}),P[v.toLowerCase()]]})})}),Object(U.jsx)(l.c,{initialValues:{slot:v},onSubmit:function(e){e.slot!==v&&O(e.slot)},children:Object(U.jsx)(l.b,{className:"row justify-content-lg-center",children:Object(U.jsxs)("div",{className:"col-12 text-center",children:[Object(U.jsx)("h3",{children:"Choose a cartidge"}),Object(U.jsx)(l.a,{as:"select",className:"form-control",name:"slot",children:N.map((function(e){return Object(U.jsx)("option",{value:e.toLowerCase(),children:e},e)}))}),Object(U.jsx)("hr",{}),Object(U.jsx)("button",{className:"btn btn-primary",type:"submit",children:"Load"}),Object(U.jsx)("hr",{})]})})}),Object.keys(S).length>0&&Object(U.jsxs)("div",{className:"row",children:[Object(U.jsx)("div",{className:"col-12",children:Object(U.jsx)(p.a,{trigger:"Debug",triggerTagName:"button",triggerClassName:"btn btn-primary d-block mx-auto",triggerOpenedClassName:"btn btn-primary d-block mx-auto",children:Object(U.jsx)("div",{className:"d-block w-100",children:Object(U.jsxs)("table",{className:"table table-dark debug-table",children:[Object(U.jsx)("thead",{children:Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"col",children:"Key"}),Object(U.jsx)("th",{scope:"col",children:"Value"})]})}),Object(U.jsxs)("tbody",{children:[Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Speed"}),Object(U.jsx)("td",{children:null===S||void 0===S?void 0:S.speed})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Frame"}),Object(U.jsx)("td",{children:null===S||void 0===S?void 0:S.frame})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Counter"}),Object(U.jsx)("td",{children:null===S||void 0===S||null===(e=S.cpu)||void 0===e?void 0:e.counter})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Delay Timer"}),Object(U.jsx)("td",{children:null===S||void 0===S||null===(t=S.cpu)||void 0===t?void 0:t.delayTimer})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Key Pressed"}),Object(U.jsx)("td",{children:null===S||void 0===S||null===(s=S.cpu)||void 0===s?void 0:s.key})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Pointer"}),Object(U.jsx)("td",{children:null===S||void 0===S||null===(r=S.cpu)||void 0===r?void 0:r.pointer})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Registers"}),Object(U.jsx)("td",{children:Object(U.jsx)(L,{data:null===S||void 0===S||null===(n=S.cpu)||void 0===n?void 0:n.registers,format:"stack"})})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Running"}),Object(U.jsx)("td",{children:String(null===S||void 0===S||null===(c=S.cpu)||void 0===c?void 0:c.running)})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Sound Timer"}),Object(U.jsx)("td",{children:null===S||void 0===S||null===(d=S.cpu)||void 0===d?void 0:d.soundTimer})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Stack"}),Object(U.jsx)("td",{children:Object(U.jsx)(L,{data:null===S||void 0===S||null===(j=S.cpu)||void 0===j?void 0:j.stack,format:"stack"})})]}),Object(U.jsxs)("tr",{children:[Object(U.jsx)("th",{scope:"row",children:"Cpu Stack Pointer"}),Object(U.jsx)("td",{children:null===S||void 0===S||null===(f=S.cpu)||void 0===f?void 0:f.stackPointer})]})]})]})})})}),Object(U.jsxs)("div",{className:"col-12 text-center",children:[Object(U.jsx)("hr",{}),Object(U.jsx)("a",{className:"btn btn-light",href:"https://github.com/PenguinOfWar/chip.ts",children:"View code on GitHub"})]})]})]})},A=function(e){e&&e instanceof Function&&s.e(3).then(s.bind(null,67)).then((function(t){var s=t.getCLS,i=t.getFID,r=t.getFCP,n=t.getLCP,c=t.getTTFB;s(e),i(e),r(e),n(e),c(e)}))};s(65);c.a.render(Object(U.jsx)(r.a.StrictMode,{children:Object(U.jsx)(E,{})}),document.getElementById("root")),A()}},[[66,1,2]]]);
//# sourceMappingURL=main.d53bd899.chunk.js.map